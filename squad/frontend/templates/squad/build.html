{% extends "squad/base.html" %}
{% load squad %}
{% load static %}

{% block content %}
{% include "squad/build-nav.html" %}

<div class="row">
<h2>Metadata</h2>
    {% for key, value in metadata %}
    <div class="row top-line">
        <div class="col-md-3">{{key}}</div>
        <div class="col-md-9">{{value|urlize}}</div>
    </div>
    {% endfor %}
</div>

<div class="row" ng-app='SquadResubmit'>
<h2>Test runs</h2>
    {% for test_run in build.test_runs.all %}
    <div class="row top-line bg-warning">
        <div class='col-md-12 warning'>
        <th colspan='3'>
            <h4>
                <a href="{% project_url test_run %}">Test run #{{test_run.job_id}}</a>
                <small>
                    Environment: <em>{{test_run.environment.slug}}</em>

                    {% if test_run.job_status %}
                    Status: {{test_run.job_status}}
                    {% endif %}

                    <div class='pull-right'>
                        {% if test_run.resubmit_url %}
                        <a href="{{test_run.resubmit_url}}" class='btn btn-info '><span class='fa fa-recycle'></span> resubmit</a>
                        {% endif %}
                        {% if user.is_staff or user.is_superuser %}
                        {% for test_job in test_run.test_jobs.all %}
                        {% if test_job.can_resubmit %}
                        <a ng-controller='ResubmitController' class="btn" ng-click="done || resubmit({{test_job.id}})" ng-class="{'btn-info': !done, 'btn-success': done}" ng-disabled="done" ><span ng-class="{'fa':true, 'fa-recycle':!done, 'fa-check': done, 'fa-spin': loading}" ng-disabled="done">{{test_job.job_id}} - resubmit</span></a>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                        {% if test_run.job_url %}
                        <a href="{{test_run.job_url}}" class='btn btn-info '><span class='fa fa-info-circle'></span> origin</a>
                        {% endif %}
                    </div>

                </small>
            </h4>
        </div>
    </div>
    <div class="row">
        <div class="col-md-3">Suite</div>
        <div class="col-md-3">Metrics summary</div>
        <div class="col-md-6">Tests</div>
    </div>
    <div class="row">
        <div class="col-md-1 col-md-offset-6">
            <span class="badge alert-default">Total</span>
        </div>
        <div class="col-md-1">
            <span class="badge alert-success">Pass</span>
        </div>
        <div class="col-md-1">
            <span class="badge alert-warning">Skip</span>
        </div>
        <div class="col-md-1">
            <span class="badge alert-danger">Fail</span>
        </div>
    </div>
    {% for status in test_run.status.by_suite.all %}
    {% if status %}
    <div class="row top-line">
        <div class="col-md-3">{{status.suite.slug}}</div>
        <div class="col-md-3">
            {% if status.has_metrics %}{{status.metrics_summary}}{% endif %}
        </div>
        {% if status.has_tests %}
        <div class="col-md-1">
            <span class="badge" data-toggle="tooltip" data-placement="top" title="Total">{{status.tests_total}}</span>
        </div>
        <div class="col-md-1">
            <span class="badge alert-success" data-toggle="tooltip" data-placement="top" title="Pass">{{status.tests_pass}}</span>
        </div>
        <div class="col-md-1">
            <span class="badge alert-warning" data-toggle="tooltip" data-placement="top" title="Skip">{{status.tests_skip}}</span>
        </div>
        <div class="col-md-1">
            <span class="badge alert-danger" data-toggle="tooltip" data-placement="top" title="Fail">{{status.tests_fail}}</span>
        </div>
        {% endif %}
    </div>
    {% endif %}
    {% endfor %}
    {% endfor %}
</div>
{% endblock %}


{% block javascript %}
<script type="text/javascript" src='{% static "squad/resubmit.js" %}'></script>
{% endblock %}
